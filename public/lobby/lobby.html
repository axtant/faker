<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lobby - Matchmaking Veto</title>
    <link rel="stylesheet" href="../styles/lobby.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="lobby">
        <div class="lobby-header">
            <div class="match-title">
                <span id="matchup">Lobby</span>
            </div>
            <div class="turn-indicator" id="turnIndicator">Loading...</div>
        </div>

        <div class="lobby-stage">
            <aside class="team team-a">
                <div class="team-header">
                    <div class="team-name" id="teamAName">Team A</div>
                    <div class="team-captain" id="teamACaptain">Captain</div>
                </div>
                <ul class="team-players" id="teamAPlayers"></ul>
            </aside>

            <main class="veto-center">
                <div class="veto-flow">
                    <div class="veto-step active" id="vetoStep">Veto Phase</div>
                </div>
                <div class="map-grid" id="mapPool"></div>
                <div class="bans" id="bans"></div>
                <div class="final-map hidden" id="finalMap">
                    <span class="label">Final Map</span>
                    <span class="value" id="selectedMap"></span>
                </div>
            </main>

            <aside class="team team-b">
                <div class="team-header">
                    <div class="team-name" id="teamBName">Team B</div>
                    <div class="team-captain" id="teamBCaptain">Captain</div>
                </div>
                <ul class="team-players" id="teamBPlayers"></ul>
            </aside>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const socket = io('', {
            query: {
                userId: params.get('userId') || 'testUser',
                displayName: params.get('displayName') || 'TestUser'
            }
        });
        const lobbyId = params.get('lobbyId');
        let currentUserId = params.get('userId');
        let lastLobby = null;

        if (!currentUserId) {
            fetch('/api/user')
                .then(r => r.json())
                .then(u => { 
                    currentUserId = String(u.id);
                    if (lastLobby) renderLobby(lastLobby);
                })
                .catch(() => {});
        }

        function renderLobby(lobby) {
            // Teams
            const aCaptain = lobby.captains[0];
            const bCaptain = lobby.captains[1];
            document.getElementById('teamAName').textContent = `Team ${aCaptain?.displayName || 'A'}`;
            document.getElementById('teamBName').textContent = `Team ${bCaptain?.displayName || 'B'}`;
            document.getElementById('teamACaptain').textContent = aCaptain ? aCaptain.displayName : '';
            document.getElementById('teamBCaptain').textContent = bCaptain ? bCaptain.displayName : '';

            document.getElementById('teamAPlayers').innerHTML = lobby.teams.A.map(p =>
                `<li class="player">${p.displayName}${lobby.captains.some(c => c.id === p.id) ? ' <span class="role">(C)</span>' : ''}</li>`
            ).join('');
            document.getElementById('teamBPlayers').innerHTML = lobby.teams.B.map(p =>
                `<li class="player">${p.displayName}${lobby.captains.some(c => c.id === p.id) ? ' <span class="role">(C)</span>' : ''}</li>`
            ).join('');

            // Header
            const matchup = `${aCaptain?.displayName || 'Team A'} vs ${bCaptain?.displayName || 'Team B'}`;
            document.getElementById('matchup').textContent = matchup;

            // Veto / Turn state
            const currentCaptain = lobby.captains[lobby.currentTurnIndex % 2];
            const myTurn = currentCaptain && String(currentCaptain.id) === String(currentUserId);
            document.getElementById('turnIndicator').textContent = lobby.lobbyCompleted
                ? 'Veto complete'
                : `${currentCaptain?.displayName || ''} is banning` + (myTurn ? ' (Your turn)' : '');

            // Map grid
            const mapPoolEl = document.getElementById('mapPool');
            mapPoolEl.innerHTML = '';
            lobby.mapPool.forEach(map => {
                const btn = document.createElement('button');
                btn.className = 'map-card' + (myTurn ? ' actionable' : '');
                btn.textContent = map;
                btn.disabled = !myTurn || lobby.lobbyCompleted;
                btn.onclick = () => socket.emit('lobbyAction', { lobbyId, action: 'ban', map });
                mapPoolEl.appendChild(btn);
            });

            // Bans list
            const bansEl = document.getElementById('bans');
            bansEl.innerHTML = lobby.bans.map((m, i) =>
                `<span class="ban-chip ${i % 2 === 0 ? 'a' : 'b'}">Ban ${i + 1}: ${m}</span>`
            ).join('');

            // Final map
            const finalEl = document.getElementById('finalMap');
            if (lobby.lobbyCompleted) {
                finalEl.classList.remove('hidden');
                document.getElementById('selectedMap').textContent = lobby.finalMap;
            } else {
                finalEl.classList.add('hidden');
            }
        }

        socket.emit('joinLobby', lobbyId);

        socket.on('lobbyUpdated', (lobby) => {
            lastLobby = lobby;
            renderLobby(lobby);
        });

        socket.on('lobbyError', (msg) => {
            alert(msg);
        });
    </script>
</body>
</html>
