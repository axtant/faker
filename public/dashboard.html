<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard - CS2 Matchmaking</title>
  <link rel="stylesheet" href="styles/styles.css" />
  <link rel="stylesheet" href="styles/settings.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
</head>

<body>
  <div class="container">

    <main class="main-content">
      <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
        <p>Loading your profile...</p>
      </div>

      <div class="dashboard-content" id="dashboardContent" style="display: none;">
        <div class="dashboard-grid">
          <aside class="sidebar">
            <nav class="sidebar-nav" id="sidebarNav"></nav>
            <div class="sidebar-footer">
              <a href="#" id="settingsLink" class="btn">User Settings</a>
              <button id="logoutBtn2" class="btn btn-danger">Logout</button>
            </div>
          </aside>

          <section class="main-panel">
            <div id="mainViewRoot"></div>
          </section>
        </div>
      </div>
    </main>

    <footer class="footer">
      <div class="footer-content">
        <p>&copy; 2025 ∆é‘Ä‚ÖÑH·ÑÖ Games Your privacy is protected.</p>
      </div>
    </footer>
  </div>

  <script>
    let currentUser = null;
    let inQueue = false;
    let socket = null;
    let currentView = 'pug';

    const sidebarNav = document.getElementById('sidebarNav');

    // --- USER PROFILE ---
    async function loadUserProfile() {
      try {
        const response = await fetch('/api/user');
        if (response.status === 401) {
          // Guest Mode
          console.log('User is guest');
          currentUser = null;
          handleGuestMode();
        } else if (response.ok) {
          currentUser = await response.json();
          handleUserMode();
        } else {
          throw new Error('Failed to load user profile');
        }
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'block';
      } catch (error) {
        console.error('Error loading user profile:', error);
        // Fallback to guest mode on error to allow navigation
        currentUser = null;
        handleGuestMode();
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'block';
      }
    }

    function handleGuestMode() {
      // Hide User specific sidebar items
      const settingsLink = document.getElementById('settingsLink');
      const logoutBtn = document.getElementById('logoutBtn2');
      if (settingsLink) settingsLink.style.display = 'none';

      // Change Logout to Login
      if (logoutBtn) {
        logoutBtn.textContent = 'Login with Steam';
        logoutBtn.classList.remove('btn-danger');
        logoutBtn.classList.add('btn-primary');
        // Remove old event listeners by cloning
        const newBtn = logoutBtn.cloneNode(true);
        logoutBtn.parentNode.replaceChild(newBtn, logoutBtn);
        newBtn.addEventListener('click', () => window.location.href = '/auth/steam');
      }
    }

    function handleUserMode() {
      // Ensure settings and logout are correct
      const settingsLink = document.getElementById('settingsLink');
      const logoutBtn = document.getElementById('logoutBtn2');
      if (settingsLink) settingsLink.style.display = 'inline-flex';

      if (logoutBtn) {
        logoutBtn.textContent = 'Logout';
        logoutBtn.classList.add('btn-danger');
        logoutBtn.classList.remove('btn-primary');
        bindLogout(logoutBtn);
      }
      setupSocket();
    }

    // --- SOCKET SETUP ---
    function setupSocket() {
      if (!currentUser) return;
      socket = io('', {
        query: {
          userId: currentUser.id,
          displayName: currentUser.displayName
        }
      });

      socket.on('connect', () => {
        console.log('Connected to matchmaking socket');
      });

      socket.on('queueUpdated', (data) => {
        const qEl = document.getElementById('queueSize');
        if (qEl) qEl.textContent = data.queueSize;
      });

      socket.on('matchCreated', (data) => {
        if (data.players.some(p => p.id === currentUser.id)) {
          window.location.href = `/lobby/lobby.html?lobbyId=${data.lobbyId}`;
        }
      });

      socket.on('disconnect', () => {
        console.log('Disconnected from matchmaking socket');
      });
    }

    // --- QUEUE JOIN/LEAVE ---
    async function handleQueueToggle(buttons, matchFoundPanel) {
      if (!currentUser) {
        window.location.href = '/auth/steam';
        return;
      }

      buttons.forEach(b => b.disabled = true);
      if (matchFoundPanel) matchFoundPanel.style.display = 'none';

      if (!inQueue) {
        buttons.forEach(b => b.textContent = 'Joining...');
        try {
          const res = await fetch('/api/matchmaking/start', { method: 'POST' });
          if (!res.ok) throw new Error('Failed to join queue');
          buttons.forEach(b => b.textContent = 'Leave Queue');
          inQueue = true;
        } catch (err) {
          alert('Failed to join matchmaking queue.');
          buttons.forEach(b => b.textContent = 'Start Matchmaking');
          console.error(err);
        }
      } else {
        buttons.forEach(b => b.textContent = 'Leaving...');
        try {
          const res = await fetch('/api/matchmaking/leave', { method: 'POST' });
          if (!res.ok) throw new Error('Failed to leave queue');
          buttons.forEach(b => b.textContent = 'Start Matchmaking');
          inQueue = false;
        } catch (err) {
          alert('Failed to leave matchmaking queue.');
          buttons.forEach(b => b.textContent = 'Leave Queue');
          console.error(err);
        }
      }
      buttons.forEach(b => b.disabled = false);
    }

    // --- NAV + VIEWS ---
    const NAV_ITEMS = [
      { id: 'pug', label: 'PUG' },
      { id: 'leaderboard', label: 'Leaderboard' },
      { id: 'inventory', label: 'Inventory' },
    ];

    function renderNav(items) {
      if (!sidebarNav) return;
      sidebarNav.innerHTML = items.map(i => `<button class="nav-item${i.id === currentView ? ' active' : ''}" data-view="${i.id}">${i.label}</button>`).join('');
      sidebarNav.addEventListener('click', (e) => {
        const target = e.target.closest('.nav-item');
        if (!target) return;
        const view = target.getAttribute('data-view');
        if (view) setActiveView(view);
      });
    }

    function renderViewPug() {
      const root = document.getElementById('mainViewRoot');
      if (!root) return;

      const isGuest = !currentUser;
      const btnText = isGuest ? 'Login to Play' : 'Start Matchmaking';

      root.innerHTML = `
        <div class="pug-quickmatch">
          <div class="pug-card">
            <h3>üéØ Quick Match</h3>
            ${currentUser && currentUser.currentLobbyId ?
          `<div class="active-lobby-alert">
                 <p>‚ö†Ô∏è You are currently in an active lobby!</p>
                 <a href="/lobby/lobby.html?lobbyId=${currentUser.currentLobbyId}" class="btn btn-success" style="margin-top:10px; display:inline-block;">Return to Matchroom</a>
               </div>`
          :
          `<div class="queue-meta">Players in queue: <span id="queueSize">0</span></div>
               <button id="toggleQueueBtn" class="btn btn-primary">Start Matchmaking</button>`
        }
            <div id="matchFound" class="match-found" style="display:none;">
              <p>üéâ Match found! Players:</p>
              <ul id="matchPlayersList" style="list-style: none; padding: 0; margin-top: 12px;"></ul>
            </div>
          </div>
        </div>`;
      const btn = document.getElementById('toggleQueueBtn');
      const matchFoundPanel = document.getElementById('matchFound');

      if (btn) {
        if (isGuest) {
          btn.addEventListener('click', () => window.location.href = '/auth/steam');
        } else {
          btn.addEventListener('click', async () => {
            await handleQueueToggle([btn], matchFoundPanel);
          });
        }
      }
    }

    function renderViewSettings() {
      const root = document.getElementById('mainViewRoot');
      if (!root) return;

      if (!currentUser) {
        root.innerHTML = '<div class="panel"><p>Please login to view settings.</p></div>';
        return;
      }

      root.innerHTML = `
        <div class="panel">
          <h3 style="margin-bottom: 12px;">User Settings</h3>
          <div class="profile-card">
            <div class="profile-header">
              <img id="userAvatar" class="avatar" src="" alt="User Avatar" />
              <div class="profile-info">
                <h2 id="displayName" class="profile-name"></h2>
                <p id="realName" class="real-name"></p>
                <div class="profile-meta">
                  <span id="steamId" class="steam-id"></span>
                  <span id="lastLogin" class="last-login"></span>
                </div>
              </div>
            </div>
            <div class="profile-actions">
              <a id="profileLink" href="#" target="_blank" class="view-profile-btn">View Steam Profile</a>
            </div>
          </div>
        </div>`;
      if (currentUser) displayUserProfile(currentUser);
    }

    function renderViewLeaderboard() {
      const root = document.getElementById('mainViewRoot');
      if (!root) return;
      root.innerHTML = `<div class="panel"><h3 style="margin-bottom: 8px;">Leaderboard</h3><div class="leaderboard-list" id="leaderboardList"><span>Coming soon</span></div></div>`;
    }

    function renderViewInventory() {
      const root = document.getElementById('mainViewRoot');
      if (!root) return;
      root.innerHTML = `<div class="panel"><h3 style="margin-bottom: 8px;">Inventory</h3><div class="inventory-list" id="inventoryList"><span>Coming soon</span></div></div>`;
    }

    function setActiveView(viewId) {
      currentView = viewId;
      document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
      if (sidebarNav) {
        const activeBtn = sidebarNav.querySelector(`[data-view="${viewId}"]`);
        if (activeBtn) activeBtn.classList.add('active');
      }
      if (viewId === 'pug') renderViewPug();
      else if (viewId === 'leaderboard') renderViewLeaderboard();
      else if (viewId === 'inventory') renderViewInventory();
      else if (viewId === 'settings') renderViewSettings();
    }

    const logoutBtnSidebar = document.getElementById('logoutBtn2');
    const settingsLinkEl = document.getElementById('settingsLink');

    const bindLogout = (el) => {
      if (!el) return;
      const newEl = el.cloneNode(true);
      el.parentNode.replaceChild(newEl, el);

      newEl.addEventListener('click', async () => {
        try {
          const res = await fetch('/logout', { method: 'POST' });
          if (res.ok) window.location.reload();
          else window.location.reload();
        } catch (err) {
          console.error('Logout failed', err);
          window.location.reload();
        }
      });
    };

    if (settingsLinkEl) {
      settingsLinkEl.addEventListener('click', (e) => {
        e.preventDefault();
        setActiveView('settings');
      });
    }

    // --- INIT ---
    window.addEventListener('DOMContentLoaded', async () => {
      await loadUserProfile();
      renderNav(NAV_ITEMS);
      setActiveView(currentView);
    });
  </script>
</body>

</html>