  <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - Steam Authentication App</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <div class="header-content">
          <h1 class="title">Steam Dashboard</h1>
          <div class="header-actions">
            <button id="logoutBtn" class="logout-btn">Logout</button>
          </div>
        </div>
      </header>

      <main class="main-content">
        <div class="loading-spinner" id="loadingSpinner">
          <div class="spinner"></div>
          <p>Loading your profile...</p>
        </div>

        <div class="dashboard-content" id="dashboardContent" style="display: none;">
          <!-- User Profile Card -->
          <div class="profile-card">
            <div class="profile-header">
              <img id="userAvatar" class="avatar" src="" alt="User Avatar" />
              <div class="profile-info">
                <h2 id="displayName" class="profile-name"></h2>
                <p id="realName" class="real-name"></p>
                <div class="profile-meta">
                  <span id="steamId" class="steam-id"></span>
                  <span id="lastLogin" class="last-login"></span>
                </div>
              </div>
            </div>
            <div class="profile-actions">
              <a id="profileLink" href="#" target="_blank" class="view-profile-btn">View Steam Profile</a>
            </div>
          </div>

          <!-- Friends Access Card -->
          <div class="friends-card">
            <div class="friends-header">
              <h3 class="friends-title">Friends List Access</h3>
              <div id="friendsAccessStatus" class="access-status">
                <span class="status-badge denied">Access Denied</span>
              </div>
            </div>

            <div id="friendsAccessContent"></div>
          </div>

          <!-- Friends List Section -->
          <div class="friends-list-section" id="friendsListSection" style="display: none;">
            <h3 class="section-title">Your Steam Friends</h3>
            <div class="friends-grid" id="friendsGrid"></div>
          </div>

          <!-- Matchmaking Section -->
          <div class="matchmaking-card">
            <h3>Matchmaking</h3>
            <p>Players in queue: <span id="queueSize">0</span></p>
            <button id="toggleQueueBtn">Start Matchmaking</button>
            <div id="matchFound" class="match-found" style="display:none;">
              <p>Match found! Players:</p>
              <ul id="matchPlayersList"></ul>
            </div>
          </div>
        </div>
      </main>

      <footer class="footer">
        <div class="footer-content">
          <p>&copy; 2024 Steam Authentication App. Your privacy is protected.</p>
        </div>
      </footer>
    </div>

    <script>
      let currentUser = null;

      const toggleQueueBtn = document.getElementById('toggleQueueBtn');
      const queueSizeEl = document.getElementById('queueSize');
      const matchFoundEl = document.getElementById('matchFound');
      const matchPlayersList = document.getElementById('matchPlayersList');
      const friendsAccessStatus = document.getElementById('friendsAccessStatus');
      const friendsAccessContent = document.getElementById('friendsAccessContent');
      const friendsListSection = document.getElementById('friendsListSection');
      const friendsGrid = document.getElementById('friendsGrid');

      let inQueue = false;
      let socket = null;

      async function loadUserProfile() {
        try {
          const response = await fetch('/api/user');
          if (!response.ok) {
            if (response.status === 401) {
              window.location.href = '/';
              return;
            }
            throw new Error('Failed to load user profile');
          }
          currentUser = await response.json();
          displayUserProfile(currentUser);
          displayFriendsAccess(currentUser);
          document.getElementById('loadingSpinner').style.display = 'none';
          document.getElementById('dashboardContent').style.display = 'block';
        } catch (error) {
          console.error('Error loading user profile:', error);
          alert('Failed to load user profile. Please refresh.');
        }
      }

      function displayUserProfile(user) {
        document.getElementById('userAvatar').src = user.avatarUrl || '/default-avatar.png';
        document.getElementById('displayName').textContent = user.displayName;
        document.getElementById('realName').textContent = user.realName || '';
        document.getElementById('steamId').textContent = `Steam ID: ${user.steamId}`;
        document.getElementById('profileLink').href = user.profileUrl;

        if (user.lastLoginAt) {
          const lastLogin = new Date(user.lastLoginAt).toLocaleDateString();
          document.getElementById('lastLogin').textContent = `Last login: ${lastLogin}`;
        }
      }

      function displayFriendsAccess(user) {
        if (user.friendsListAccess) {
          friendsAccessStatus.innerHTML = '<span class="status-badge granted">Access Granted</span>';
          friendsAccessContent.innerHTML = `
            <div class="access-granted">
              <p class="access-description">
                âœ“ You have granted access to your Steam friends list.
                We can now display your friends and their information.
              </p>
              <button id="refreshFriendsBtn" class="refresh-btn">Refresh Friends List</button>
            </div>
          `;
          loadFriendsList();
        } else {
          friendsAccessStatus.innerHTML = '<span class="status-badge denied">Access Denied</span>';
          friendsAccessContent.innerHTML = `
            <div class="access-request">
              <p class="access-description">
                To display your Steam friends list, we need your permission to access this information.
              </p>
              <div class="permission-info">
                <h4>What we'll access:</h4>
                <ul>
                  <li>Your Steam friends list</li>
                  <li>Basic profile information of your friends</li>
                  <li>Friends since dates</li>
                </ul>
              </div>
              <button id="grantAccessBtn" class="grant-access-btn">Grant Friends List Access</button>
            </div>
          `;
        }
      }

      async function loadFriendsList() {
        try {
          const response = await fetch('/api/friends');
          if (response.ok) {
            const friends = await response.json();
            displayFriendsList(friends);
            friendsListSection.style.display = 'block';
          } else {
            friendsListSection.style.display = 'none';
          }
        } catch (error) {
          console.error('Error loading friends list:', error);
        }
      }

      function displayFriendsList(friends) {
        if (friends.length === 0) {
          friendsGrid.innerHTML = '<p class="no-friends">No friends found or friends list is private.</p>';
          return;
        }
        friendsGrid.innerHTML = friends.map(friend => `
          <div class="friend-card">
            <img src="${friend.avatarUrl || '/default-avatar.png'}" alt="${friend.displayName}" class="friend-avatar" />
            <div class="friend-info">
              <h4 class="friend-name">${friend.displayName}</h4>
              ${friend.friendSince ? `<p class="friend-since">Friends since ${new Date(friend.friendSince).toLocaleDateString()}</p>` : ''}
              <a href="${friend.profileUrl}" target="_blank" class="friend-profile-link">View Profile</a>
            </div>
          </div>
        `).join('');
      }

      // Matchmaking functions

      function setupSocket() {
        socket = io('', { query: { userId: currentUser.id } });

        socket.on('connect', () => {
          console.log('Connected to matchmaking socket');
        });

        socket.on('matchCreated', (data) => {
          if (data.players.some(p => p.id === currentUser.id)) {
            showMatchFound(data.players);
            toggleQueueBtn.disabled = false;
            toggleQueueBtn.textContent = 'Start Matchmaking';
            inQueue = false;
          }
        });

        socket.on('disconnect', () => {
          console.log('Disconnected from matchmaking socket');
        });
      }

      function showMatchFound(players) {
        matchPlayersList.innerHTML = players.map(p => `<li>${p.displayName}</li>`).join('');
        matchFoundEl.style.display = 'block';
      }

      async function updateQueueStatus() {
        try {
          const response = await fetch('/api/matchmaking/status');
          if (!response.ok) throw new Error('Failed to fetch matchmaking status');

          const { queueSize, match } = await response.json();
          queueSizeEl.textContent = queueSize;

          if (match) {
            showMatchFound(match.players);
            toggleQueueBtn.disabled = false;
            toggleQueueBtn.textContent = 'Start Matchmaking';
            inQueue = false;
          } else {
            matchFoundEl.style.display = 'none';
          }
        } catch (e) {
          console.error(e);
        }
      }

      toggleQueueBtn.addEventListener('click', async () => {
        toggleQueueBtn.disabled = true;
        matchFoundEl.style.display = 'none';

        if (!inQueue) {
          toggleQueueBtn.textContent = 'Joining...';
          try {
            const res = await fetch('/api/matchmaking/start', { method: 'POST' });
            if (!res.ok) throw new Error('Failed to join queue');
            const { queueSize } = await res.json();
            queueSizeEl.textContent = queueSize;
            toggleQueueBtn.textContent = 'Leave Queue';
            inQueue = true;
          } catch (err) {
            alert('Failed to join matchmaking queue.');
            toggleQueueBtn.textContent = 'Start Matchmaking';
            console.error(err);
          }
        } else {
          toggleQueueBtn.textContent = 'Leaving...';
          try {
            const res = await fetch('/api/matchmaking/leave', { method: 'POST' });
            if (!res.ok) throw new Error('Failed to leave queue');
            const { queueSize } = await res.json();
            queueSizeEl.textContent = queueSize;
            toggleQueueBtn.textContent = 'Start Matchmaking';
            inQueue = false;
          } catch (err) {
            alert('Failed to leave matchmaking queue.');
            toggleQueueBtn.textContent = 'Leave Queue';
            console.error(err);
          }
        }
        toggleQueueBtn.disabled = false;
      });

      document.addEventListener('click', async (e) => {
        if (e.target.id === 'grantAccessBtn') {
          e.target.disabled = true;
          e.target.textContent = 'Granting Access...';
          try {
            const res = await fetch('/api/grant-friends-access', { method: 'POST' });
            if (!res.ok) throw new Error('Failed to grant access');
            await loadUserProfile();
          } catch (err) {
            alert('Failed to grant friends access.');
            e.target.disabled = false;
            e.target.textContent = 'Grant Friends List Access';
          }
        }
        if (e.target.id === 'refreshFriendsBtn') {
          e.target.disabled = true;
          e.target.textContent = 'Refreshing...';
          try {
            const res = await fetch('/api/grant-friends-access', { method: 'POST' });
            if (res.ok) await loadFriendsList();
          } catch {
            alert('Failed to refresh friends list.');
          } finally {
            e.target.disabled = false;
            e.target.textContent = 'Refresh Friends List';
          }
        }
      });

      document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
          const res = await fetch('/logout', { method: 'POST' });
          if (res.ok) window.location.href = '/';
        } catch (err) {
          console.error('Logout failed', err);
        }
      });

      // Initialize
      window.addEventListener('DOMContentLoaded', async () => {
        await loadUserProfile();
        setupSocket();
        setInterval(updateQueueStatus, 10000);
      });
    </script>
  </body>
  </html>
