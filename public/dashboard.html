<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard - CS2 Matchmaking</title>
  <link rel="stylesheet" href="styles/styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="header-content">
        <div>
          <h1 class="title">CS2 Matchmaking</h1>
          <p class="subtitle">Ready to dominate the battlefield?</p>
        </div>
        <div class="header-actions">
          <button id="logoutBtn" class="btn btn-danger">Logout</button>
        </div>
      </div>
    </header>

    <main class="main-content">
      <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
        <p>Loading your profile...</p>
      </div>

      <div class="dashboard-content" id="dashboardContent" style="display: none;">
        <!-- User Profile Card -->
        <div class="profile-card">
          <div class="profile-header">
            <img id="userAvatar" class="avatar" src="" alt="User Avatar" />
            <div class="profile-info">
              <h2 id="displayName" class="profile-name"></h2>
              <p id="realName" class="real-name"></p>
              <div class="profile-meta">
                <span id="steamId" class="steam-id"></span>
                <span id="lastLogin" class="last-login"></span>
              </div>
            </div>
          </div>
          <div class="profile-actions">
            <a id="profileLink" href="#" target="_blank" class="view-profile-btn">View Steam Profile</a>
          </div>
        </div>

        <!-- Matchmaking Section -->
        <div class="matchmaking-card">
          <h3>ðŸŽ¯ Quick Match</h3>
          <p style="color: var(--text-secondary); margin-bottom: 20px;">
            Players in queue: <span id="queueSize" style="color: var(--neon-cyan); font-weight: 700;">0</span>
          </p>
          <button id="toggleQueueBtn" class="btn btn-primary">Start Matchmaking</button>
          <div id="matchFound" class="match-found" style="display:none;">
            <p>ðŸŽ‰ Match found! Players:</p>
            <ul id="matchPlayersList" style="list-style: none; padding: 0; margin-top: 12px;"></ul>
          </div>
        </div>
      </div>
    </main>

    <footer class="footer">
      <div class="footer-content">
        <p>&copy; 2024 CS2 Matchmaking Platform. Your privacy is protected.</p>
      </div>
    </footer>
  </div>

  <script>
    let currentUser = null;
    let inQueue = false;
    let socket = null;

    const toggleQueueBtn = document.getElementById('toggleQueueBtn');
    const queueSizeEl = document.getElementById('queueSize');
    const matchFoundEl = document.getElementById('matchFound');
    const matchPlayersList = document.getElementById('matchPlayersList');

    // --- USER PROFILE ---
    async function loadUserProfile() {
      try {
        const response = await fetch('/api/user');
        if (!response.ok) {
          if (response.status === 401) {
            window.location.href = '/';
            return;
          }
          throw new Error('Failed to load user profile');
        }
        currentUser = await response.json();
        displayUserProfile(currentUser);
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'block';
      } catch (error) {
        console.error('Error loading user profile:', error);
        alert('Failed to load user profile. Please refresh.');
      }
    }

    function displayUserProfile(user) {
      document.getElementById('userAvatar').src = user.avatarUrl || '/default-avatar.png';
      document.getElementById('displayName').textContent = user.displayName;
      document.getElementById('realName').textContent = user.realName || '';
      document.getElementById('steamId').textContent = `Steam ID: ${user.steamId}`;
      document.getElementById('profileLink').href = user.profileUrl;

      if (user.lastLoginAt) {
        const lastLogin = new Date(user.lastLoginAt).toLocaleDateString();
        document.getElementById('lastLogin').textContent = `Last login: ${lastLogin}`;
      }
    }

    // --- SOCKET SETUP ---
    function setupSocket() {
      socket = io('', {
        query: {
          userId: currentUser.id,
          displayName: currentUser.displayName
        }
      });

      socket.on('connect', () => {
        console.log('Connected to matchmaking socket');
      });

      socket.on('queueUpdated', (data) => {
        queueSizeEl.textContent = data.queueSize;
      });

      socket.on('matchCreated', (data) => {
        if (data.players.some(p => p.id === currentUser.id)) {
          window.location.href = `/lobby/lobby.html?lobbyId=${data.lobbyId}`;
        }
      });

      socket.on('disconnect', () => {
        console.log('Disconnected from matchmaking socket');
      });
    }

    function showMatchFound(players) {
      matchPlayersList.innerHTML = players.map(p => `<li style="padding: 4px 0; color: var(--text-primary);">ðŸ‘¤ ${p.displayName}</li>`).join('');
      matchFoundEl.style.display = 'block';
    }

    // --- QUEUE JOIN/LEAVE ---
    toggleQueueBtn.addEventListener('click', async () => {
      toggleQueueBtn.disabled = true;
      matchFoundEl.style.display = 'none';

      if (!inQueue) {
        toggleQueueBtn.textContent = 'Joining...';
        try {
          const res = await fetch('/api/matchmaking/start', { method: 'POST' });
          if (!res.ok) throw new Error('Failed to join queue');
          toggleQueueBtn.textContent = 'Leave Queue';
          inQueue = true;
        } catch (err) {
          alert('Failed to join matchmaking queue.');
          toggleQueueBtn.textContent = 'Start Matchmaking';
          console.error(err);
        }
      } else {
        toggleQueueBtn.textContent = 'Leaving...';
        try {
          const res = await fetch('/api/matchmaking/leave', { method: 'POST' });
          if (!res.ok) throw new Error('Failed to leave queue');
          toggleQueueBtn.textContent = 'Start Matchmaking';
          inQueue = false;
        } catch (err) {
          alert('Failed to leave matchmaking queue.');
          toggleQueueBtn.textContent = 'Leave Queue';
          console.error(err);
        }
      }
      toggleQueueBtn.disabled = false;
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        const res = await fetch('/logout', { method: 'POST' });
        if (res.ok) window.location.href = '/';
      } catch (err) {
        console.error('Logout failed', err);
      }
    });

    // --- INIT ---
    window.addEventListener('DOMContentLoaded', async () => {
      await loadUserProfile();
      setupSocket();
    });
  </script>
</body>
</html>